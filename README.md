# discourse-choujiang 抽奖插件

定时自动开奖的 Discourse 抽奖插件。支持按固定格式发帖或通过独立表单页面（`/lottery/create`）快速创建抽奖活动。  
当前版本：**0.5**

---

## 功能简介

- 发起人可在指定标签下按模板发帖发起抽奖
- 抽奖帖需包含：抽奖名称、活动奖品、获奖人数、开奖时间、（可选）最低积分、简单说明
- 用户只需“回复”即参与（无需点击按钮或登记）
- 到开奖时间自动：
  - 随机抽取指定数量的唯一用户（剔除发起人与重复参与）
  - 追加开奖结果到首贴
  - 给获奖者的首个回复添加标记
  - 发送系统私信通知获奖者
  - 给主题添加“已开奖”标签（`choujiang_drawn_tag`，默认“抽奖结束”）
  - 关闭主题防止继续回复
- 支持“最低积分”门槛（来自 `discourse-gamification` 积分；为空或 0 表示不限制）
- v0.5 新增：独立发布页面 `/lottery/create`（未登录显示登录提示与帮助链接），仅作为格式化创建方式，不改变原开奖逻辑

---

## 目录

1. [快速预览](#快速预览)  
2. [安装](#安装)  
3. [站点设置](#站点设置)  
4. [两种发起方式](#两种发起方式)  
5. [抽奖贴格式规范](#抽奖贴格式规范)  
6. [字段说明](#字段说明)  
7. [自动开奖逻辑说明](#自动开奖逻辑说明)  
8. [最低积分门槛说明](#最低积分门槛说明)  
9. [权限与安全](#权限与安全)  
10. [常见问题 FAQ](#常见问题-faq)  
11. [升级 / 版本说明](#升级--版本说明)  
12. [开发者指南（扩展）](#开发者指南扩展)  
13. [故障排查](#故障排查)  
14. [最近更新](#最近更新)  
15. [License](#license)

---

## 快速预览

| 功能 | 描述 |
|------|------|
| 自动开奖 | 定时任务每 5 分钟扫描符合条件的抽奖主题，到期即开奖 |
| 表单创建 | 访问 `/lottery/create` 填写表单一键发布 |
| 标签识别 | 使用站点设置 `choujiang_tag` 作为活动识别标签 |
| 中奖通知 | 系统用户私信通知获奖者 |
| 去重与排除 | 发起人和重复参与者自动剔除 |
| 最低积分 | 可选门槛，低于积分的用户不参与抽奖 |
| 开奖后处理 | 添加“已开奖”标签、写回结果、关闭主题 |

---

## 安装

在你的 Discourse 容器 `app.yml` 中 `hooks > after_code` 添加本仓库：

```yml
- git clone https://github.com/maiizii/discourse-choujiang.git
```

然后重建：

```bash
cd /var/discourse
./launcher rebuild app
```

后台 -> 设置 搜索 “抽奖”。

---

## 站点设置

| 设置键 | 默认值 | 用途 |
|--------|--------|------|
| `choujiang_enabled` | true | 是否启用插件 |
| `choujiang_tag` | 抽奖活动 | 识别抽奖主题的标签 |
| `choujiang_drawn_tag` | 抽奖结束 | 开奖后自动添加 |

> 只有带上 `choujiang_tag` 标签的主题才会被抽奖任务扫描。

---

## 两种发起方式

### 方式 A：手动发帖

1. 新建主题  
2. 在正文写规范块（见后）  
3. 添加标签（= `choujiang_tag`）  
4. 发布等待开奖

### 方式 B：表单页面 `/lottery/create`（v0.5）

1. 访问 `https://你的域名/lottery/create`（示例：`https://www.tkcall.com/lottery/create`）  
2. 登录状态下显示表单；未登录提示 + 帮助链接（例如站点帮助主题 `https://www.tkcall.com/t/topic/204`）  
3. 填写并发布，系统自动生成规范文本及标签

---

## 抽奖贴格式规范

```
[抽奖]
抽奖名称：2025年夏季抽奖
活动奖品：蓝牙耳机一副
获奖人数：2
开奖时间：2025-07-10 20:00
最低积分：10
简单说明：每人仅限一次回复参与
[/抽奖]

这里是额外补充说明（可选）
```

说明：
- `最低积分` 行可省略
- `简单说明` 可为空（建议保留行）
- 时间格式固定：`YYYY-MM-DD HH:MM`

---

## 字段说明

| 字段 | 必填 | 说明 |
|------|------|------|
| 抽奖名称 | 是 | 活动名称 |
| 活动奖品 | 是 | 奖品描述（单行） |
| 获奖人数 | 是 | 随机抽取数量 |
| 开奖时间 | 是 | 格式 `YYYY-MM-DD HH:MM` |
| 最低积分 | 否 | Gamification 积分门槛 |
| 简单说明 | 否 | 活动规则简述 |
| 额外正文 | 否 | 抽奖块后续自由内容 |

---

## 自动开奖逻辑说明

1. 定时任务（每 5 分钟）扫描带 `choujiang_tag` 且未关闭的主题  
2. 解析首贴抽奖信息（正则）  
3. 到达开奖时间则执行：
   - 收集所有回复用户（排除发起人 & 重复）  
   - 应用最低积分过滤（如有）  
   - 随机抽取获奖者  
   - 结果写回首贴末尾  
   - 给获奖者首个回复添加标记（代码已有逻辑）  
   - 发送私信通知  
   - 添加 `choujiang_drawn_tag` 标签  
   - 关闭主题  

---

## 最低积分门槛说明

- 行存在且值为正整数时启用过滤  
- 基于 `discourse-gamification` 的积分接口（外部插件需已安装并正常记录积分）  
- 不符合积分的用户不进入抽奖候选集合

---

## 权限与安全

| 项 | 说明 |
|----|------|
| 表单访问 | 任意访客可访问；未登录不可提交 |
| 主题创建权限 | 依托 Discourse 常规发帖与分类/标签权限 |
| 反滥用 | 可扩展 RateLimiter（当前最低实现未内置） |
| 数据持久化 | 当前依赖首贴文本解析；未对抽奖记录单独存表（迁移文件已预留但可选） |

---

## 常见问题 FAQ

**Q1: 开奖时间格式写错会怎样？**  
解析失败则不会开奖。请严格使用 `YYYY-MM-DD HH:MM`。

**Q2: 获奖人数大于参与人数？**  
可能导致中奖列表为空或不足，建议运营上控制；可自行扩展严校验。

**Q3: 可否编辑首贴？**  
开奖前可编辑（谨慎修改抽奖块字段）；开奖后主题关闭。

**Q4: 表单能否添加更多字段？**  
v0.5 仅保持最小功能，不改抽奖核心结构，可自行扩展。

---

## 升级 / 版本说明

| 版本 | 说明 |
|------|------|
| v0.4 | 初始版本：手动格式发帖 + 自动开奖 + 最低积分支持 |
| v0.5 | 新增 `/lottery/create` 表单页面（未登录提示 + 帮助链接），无破坏性变更 |

> v0.5 未改变原有开奖逻辑和数据结构，只增加一个辅助创建入口。

---

## 开发者指南（扩展）

| 文件 | 作用 |
|------|------|
| `plugin.rb` | 插件入口、挂载路由、加载作业 |
| `lib/choujiang.rb` | 抽奖解析与核心开奖逻辑 |
| `jobs/auto_choujiang_draw.rb` | 定时任务执行 |
| `app/controllers/discourse_choujiang/create_controller.rb` | 表单创建接口（v0.5 新增） |
| `assets/javascripts/...` | Ember 前端路由/控制器/模板 |
| `config/settings.yml` | 站点设置定义 |
| `config/locales/*.yml` | 文本国际化 |
| `db/migrate/*` | 预留数据表（如后续需要存档或统计） |

### 表单接口生成的 RAW 模板
```
[抽奖]
抽奖名称：...
活动奖品：...
获奖人数：...
开奖时间：YYYY-MM-DD HH:MM
最低积分：N          # 可选
简单说明：...
[/抽奖]

(额外正文)
```

---

## 故障排查

| 现象 | 排查建议 |
|------|----------|
| 未开奖 | 检查标签、时间格式、日志；确保未提前关闭主题 |
| 标签缺失 | 主题需包含 `choujiang_tag` |
| 积分过滤异常 | 确认 gamification 插件运行、积分存在 |
| 表单无法提交 | 打开浏览器控制台检查 422/403/500 响应 |
| 访问 404 | 重建后清缓存；确认路由 `/lottery/create` 挂载成功 |

---

## 最近更新

| 日期 | 更新内容 |
|------|----------|
| 2025-xx-xx | v0.5 发布：新增 `/lottery/create` 表单页面 |
| 2025-07-xx |（历史）添加最低积分过滤机制 |

> 请按实际发布日期修改上表中的日期。

---

## 示例（表单生成结果）

```
[抽奖]
抽奖名称：测试抽奖
活动奖品：定制周边一份
获奖人数：3
开奖时间：2025-07-10 20:00
最低积分：50
简单说明：回复任意内容即可参与
[/抽奖]

这里是更详细的活动介绍……
```

---

## License

MIT

---

## 反馈

- 欢迎提交 Issue / PR
- 站内说明贴（示例帮助链接）可放使用教程
- 建议改进：时间合法性校验、RateLimiter、预览、编辑限制、统计面板等

祝使用愉快！🎉
